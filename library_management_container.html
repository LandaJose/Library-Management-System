<!DOCTYPE html>
<html>
  <head>
    <!-- <meta charset="UTF-8" /> -->
    <title>Library – Student Checkout</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #f4f4f7;
      }

      .app {
        display: flex;
        height: 100vh;
      }

      /* LEFT PANEL – student search */
      .sidebar {
        width: 35%;
        background: #fff;
        border-right: 1px solid #ddd;
        padding: 16px;
        box-sizing: border-box;
      }

      .sidebar h2 {
        margin-top: 0;
      }

      .search-box input {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        margin-bottom: 8px;
      }

      .student-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: calc(100vh - 140px);
        overflow-y: auto;
      }

      .student-list li {
        padding: 8px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
      }

      .student-list li:hover {
        background: #f0f0ff;
      }

      .student-list li.active {
        background: #dfe7ff;
        font-weight: bold;
      }

      /* RIGHT PANEL – details + scan */
      .main {
        flex: 1;
        padding: 16px 24px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }

      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .student-name {
        font-size: 1.3rem;
        font-weight: bold;
      }

      .mode-toggle button {
        padding: 6px 12px;
        border: 1px solid #888;
        background: #eee;
        cursor: pointer;
        margin-left: 4px;
      }

      .mode-toggle button.active {
        background: #4b6cff;
        color: #fff;
        border-color: #4b6cff;
      }

      .scan-section {
        background: #fff;
        padding: 12px 16px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 16px;
      }

      .scan-section label {
        display: block;
        margin-bottom: 4px;
        font-weight: bold;
      }

      .scan-section input {
        width: 100%;
        padding: 10px;
        font-size: 1rem;
        box-sizing: border-box;
      }

      .status {
        margin-top: 8px;
        font-size: 0.95rem;
        min-height: 20px;
      }

      .status.ok {
        color: #0b7c21;
      }

      .status.error {
        color: #b00020;
      }

      .loan-list {
        background: #fff;
        padding: 12px 16px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        flex: 1;
        overflow-y: auto;
      }

      .loan-list h3 {
        margin-top: 0;
      }

      .loan-list table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }

      .loan-list th,
      .loan-list td {
        padding: 6px 4px;
        border-bottom: 1px solid #eee;
        text-align: left;
      }

      .loan-list th {
        font-weight: bold;
        background: #f9f9f9;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- LEFT: Student search -->
      <div class="sidebar">
        <h2>Students</h2>
        <div class="search-box">
          <input
            id="studentSearch"
            type="text"
            placeholder="Search student by name…"
          />
        </div>
        <ul id="studentList" class="student-list">
          <!-- filled by JS -->
        </ul>
      </div>

      <!-- RIGHT: Student details + scan -->
      <div class="main">
        <div class="header-row">
          <!-- <div class="student-name" id="studentName">Select a student…</div> -->
          <div class="mode-toggle">
            Mode:
            <button id="addBooks" class="" onclick="addBooks()">
              Add Books
            </button>
            <button id="reviewBooks" class="" onclick="viewBooks()">
              Books
            </button>
            <button id="checkOut" class="" onclick="checkOut()">
              Check-Out
            </button>
            <button id="checkIn" class="" onclick="checkIn()">Check-In</button>
          </div>
        </div>

        <div id="addBooksSection" class="hidden">
          <label for="isbnInput">Scan Book ISBN</label>
          <input type="text" id="isbnInput" placeholder="Scan Book" />
        </div>

        <div class="loan-list">
          <h3>Current Books</h3>
          <table>
            <thead>
              <tr>
                <th>Title</th>
                <th>ISBN</th>
              </tr>
            </thead>
            <tbody id="loanTableBody">
              <!-- filled by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      function addBooks() {
        clearActive();
        document.getElementById("addBooks").classList.add("active");
        document.getElementById("addBooksSection").classList.remove("hidden");
        var isbnInput = document.getElementById("isbnInput");
        if (isbnInput) {
          isbnInput.value = "";
          isbnInput.focus();
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        var isbnInput = document.getElementById("isbnInput");

        if (!isbnInput) return;

        isbnInput.addEventListener("keydown", async function (e) {
          if (e.key === "Enter") {
            e.preventDefault();

            var isbn = this.value.trim();
            if (!isbn) return;

            console.log(isbn + " THIS BOOK WAS SCANNED");

            const info = await fetchBookInfoByIsbn(isbn);
            console.log(info);

            await saveBookToDB(isbn, info.title, info.author);

            this.value = ""; // clear for next scan
          }
        });
      });

      async function saveBookToDB(isbn, title, author) {
        try {
          const result = await window.libraryAPI.addBook({
            isbn,
            title,
            author,
          });
          console.log("Book saved to DB:", result);
        } catch (err) {
          console.error("Failed to save book:", err);
        }
      }

      function viewBooks() {
        clearActive();
        document.getElementById("reviewBooks").classList.add("active");
      }

      function checkOut() {
        clearActive();
        document.getElementById("checkOut").classList.add("active");
      }

      function checkIn() {
        clearActive();
        document.getElementById("checkIn").classList.add("active");
      }

      function clearActive() {
        document.querySelectorAll("button").forEach(function (btn) {
          btn.classList.remove("active");
        });
        document.getElementById("addBooksSection").classList.add("hidden");
      }

      async function fetchBookInfoByIsbn(isbn) {
        const res = await fetch(
          "https://www.googleapis.com/books/v1/volumes?q=isbn:" +
            encodeURIComponent(isbn)
        );

        const data = await res.json();

        if (!data.items || !data.items.length) {
          return null;
        }

        const volume = data.items[0].volumeInfo;

        return {
          title: volume.title || "Unknown title",
          author:
            (volume.authors && volume.authors.join(", ")) || "Unknown author",
        };
      }
    </script>
  </body>
</html>
